{
    "variables": {
        "subnet_id": "{{env `SUBNET_ID`}}",
        "region": "{{env `AWS_REGION`}}"
    },
    "builders": [{
        "type": "amazon-ebs",
        "ami_name": "ami-pipeline-test-{{timestamp}}",
        "ssh_username": "ec2-user",
        "region": "{{user `region`}}",
        "instance_type": "t2.micro",
        "subnet_id": "{{user `subnet_id`}}",
        "source_ami_filter": {
            "filters": {
                "name": "amzn2-ami-hvm-2.0.????????-x86_64-gp2",
                "state": "available"
            },
            "owners": ["amazon"],
            "most_recent": true
        }
    }],
    "provisioners": [
        {
            "type": "shell",
            "inline": [
                "sudo yum -y update",
                "sudo yum -y install httpd",
                "sudo systemctl enable httpd",
                "sudo yum -y remove amazon-ssm-agent",
                "sudo yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm",
                "sudo systemctl enable amazon-ssm-agent"
            ]
        },
        {
            "type": "file",
            "source": "baseline.sysctl.conf",
            "destination": "/tmp/baseline.sysctl.conf"
        },
        {
            "type": "file",
            "source": "baseline.auditd.conf",
            "destination": "/tmp/baseline.auditd.conf"
        },
        {
            "type": "file",
            "source": "baseline.ssh_config",
            "destination": "/tmp/baseline.ssh_config"
        },
        {
            "type": "file",
            "source": "baseline.sshd_config",
            "destination": "/tmp/baseline.sshd_config"
        },
        {
            "type": "shell",
            "inline": [
                "sudo install -o root -g root -m 644 /tmp/baseline.sysctl.conf /etc/sysctl.d/secure-baseline.conf",
                "sudo install -o root -g root -m 640 /tmp/baseline.auditd.conf /etc/audit/auditd.conf",
                "sudo install -o root -g root -m 644 /tmp/baseline.ssh_config /etc/ssh/ssh_config",
                "sudo install -o root -g root -m 600 /tmp/baseline.sshd_config /etc/ssh/sshd_config",
                "# Remove ssh DH moduli < 2047 bits",
                "sudo awk '$5 >= 2047 { print }' /etc/ssh/moduli > /tmp/moduli.new && sudo mv /tmp/moduli.new /etc/ssh/moduli"
            ]
        }
    ],
    "post-processors": [{
        "type": "manifest",
        "output": "manifest.json",
        "strip_path": true
    }]
}
